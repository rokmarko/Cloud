{% extends "base.html" %}

{% block content %}
<!-- CSRF token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="page-header">
    <h1><span class="material-icons">dashboard</span> Instrument Layouts</h1>
    <a href="{{ url_for('dashboard.add_instrument_layout') }}" class="btn btn-primary">
        <span class="material-icons me-2">add_circle</span> Create Layout
    </a>
</div>

<!-- Instrument Layout Editor Modal -->
<div class="modal fade" id="instrumentLayoutEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-icons me-2">edit</span>
                    Instrument Layout Editor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Iframe with deferred loading - no initial src attribute -->
                <iframe 
                    id="instrumentLayoutEditor" 
                    data-src="https://www.kanardia.eu/apps/Customizer"
                    width="100%" 
                    height="100%" 
                    style="border: none; min-height: 80vh; display: none;">
                </iframe>
                <!-- Loading indicator -->
                <div id="editorLoading" class="d-flex justify-content-center align-items-center" style="height: 80vh;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">Loading Instrument Layout Editor...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span class="material-icons me-1">close</span> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="saveInstrumentLayout()">
                    <span class="material-icons me-1">save</span> Save Layout
                </button>
            </div>
        </div>
    </div>
</div>

{% if layouts %}
    <div class="row g-4">
        {% for layout in layouts %}
        <div class="col-lg-4 col-md-6">
            <div class="card layout-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <span class="material-icons me-2" style="color: var(--kanardia-orange);">dashboard</span>
                        {{ layout.title }}
                    </h5>
                    <h6 class="card-subtitle mb-3">
                        <span class="badge" style="background: var(--kanardia-red); color: white;">
                            {{ layout.category.title() }}
                        </span>
                    </h6>
                    
                    {% if layout.description %}
                        <p class="card-text">{{ layout.description[:100] }}{% if layout.description|length > 100 %}...{% endif %}</p>
                    {% endif %}
                    
                    <p class="card-text">
                        <small class="text-muted">
                            <span class="material-icons me-1" style="font-size: 1rem; vertical-align: middle;">schedule</span>
                            Created {{ layout.created_at.strftime('%m/%d/%Y') }}
                        </small>
                    </p>
                    
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-primary btn-sm" onclick="openInstrumentLayoutEditor({{ layout.id }}, '{{ layout.title }}')">
                            <span class="material-icons me-1">edit</span> Edit
                        </button>
                        <a href="{{ url_for('dashboard.export_instrument_layout', layout_id=layout.id) }}" class="btn btn-outline-success btn-sm">
                            <span class="material-icons me-1">download</span> Export
                        </a>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown">
                                <span class="material-icons">more_vert</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="duplicateInstrumentLayout({{ layout.id }})">
                                        <span class="material-icons me-2">content_copy</span> Duplicate
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" onclick="deleteInstrumentLayout({{ layout.id }})">
                                        <span class="material-icons me-2">delete</span> Delete
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center mt-5">
        <span class="material-icons mb-4" style="font-size: 6rem; color: #e0e0e0;">dashboard</span>
        <h3 class="text-muted mb-3">No instrument layouts yet</h3>
        <p class="text-muted mb-4">Create your first instrument layout to get started with the Kanardia layout editor.</p>
        <a href="{{ url_for('dashboard.add_instrument_layout') }}" class="btn btn-primary btn-lg">
            <span class="material-icons me-2">add_circle</span> Create Your First Layout
        </a>
    </div>
{% endif %}

<script>
let currentLayoutId = null;
let isEditorLoaded = false;
let modalInstance = null;

/**
 * Handle messages received from the instrument layout editor iframe
 * @param {MessageEvent} event - The message event from the iframe
 */
function handleEditorMessage(event) {
    console.log('Instrument layout editor message:', event.data);

    if (event.origin !== 'https://www.kanardia.eu') {
        return; // Ignore messages from other origins
    }
    
    if (event.data && event.data.length > 0) {
        try {
            var payload = JSON.parse(event.data);
            if (payload.event === 'init') {
                isEditorLoaded = true;
                hideLoadingIndicator();
                // Call load method after init is received
                loadInstrumentLayoutData();
            }
            else if (payload.event === 'autosave') {
                saveInstrumentLayoutData(payload.xml);
            }
        } catch (error) {
            console.error('Error parsing editor message:', error);
        }
    }
}

/**
 * Open the instrument layout editor modal and load the iframe
 * @param {number} layoutId - The ID of the layout to edit
 * @param {string} layoutTitle - The title of the layout
 */
function openInstrumentLayoutEditor(layoutId, layoutTitle) {
    currentLayoutId = layoutId;
    isEditorLoaded = false;
    
    // Update modal title
    document.querySelector('#instrumentLayoutEditorModal .modal-title').innerHTML = 
        '<span class="material-icons me-2">edit</span>Edit: ' + layoutTitle;
    
    // Show loading indicator
    showLoadingIndicator();

    // Add event listener for iframe messages
    window.addEventListener('message', handleEditorMessage);

    // Load the iframe source (deferred loading)
    const iframe = document.getElementById('instrumentLayoutEditor');
    const editorUrl = iframe.getAttribute('data-src');
    iframe.src = editorUrl;

    // Show the modal
    modalInstance = new bootstrap.Modal(document.getElementById('instrumentLayoutEditorModal'));
    modalInstance.show();
   
    // Handle modal close event to cleanup
    const modalElement = document.getElementById('instrumentLayoutEditorModal');
    modalElement.addEventListener('hidden.bs.modal', function onModalHidden() {
        cleanupEditor();
        modalElement.removeEventListener('hidden.bs.modal', onModalHidden);
    });
}

/**
 * Show the loading indicator and hide the iframe
 */
function showLoadingIndicator() {
    const loadingElement = document.getElementById('editorLoading');
    const iframe = document.getElementById('instrumentLayoutEditor');
    
    if (loadingElement) loadingElement.style.display = 'flex';
    if (iframe) iframe.style.display = 'none';
}

/**
 * Hide the loading indicator and show the iframe
 */
function hideLoadingIndicator() {
    const loadingElement = document.getElementById('editorLoading');
    const iframe = document.getElementById('instrumentLayoutEditor');
    
    if (loadingElement) loadingElement.style.display = 'none';
    if (iframe) iframe.style.display = 'block';
}

/**
 * Clean up editor resources when modal is closed
 */
function cleanupEditor() {
    // Remove event listener
    window.removeEventListener('message', handleEditorMessage);
    
    // Clear iframe source to stop loading
    const iframe = document.getElementById('instrumentLayoutEditor');
    if (iframe) {
        iframe.src = 'about:blank';
    }
    
    // Reset state
    currentLayoutId = null;
    isEditorLoaded = false;
    modalInstance = null;
    
    // Reset loading indicator
    showLoadingIndicator();
}

/**
 * Load instrument layout data from the backend and send to iframe
 */
function loadInstrumentLayoutData() {
    if (!currentLayoutId || !isEditorLoaded) return;
    
    // Get the iframe
    const iframe = document.getElementById('instrumentLayoutEditor');
    
    // Fetch layout data from your backend
    fetch(`/dashboard/api/instrument-layout/${currentLayoutId}/load_json`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Send data to the iframe
            iframe.contentWindow.postMessage(JSON.stringify({
                action: 'load', xml: JSON.stringify(data), title: "Test"
            }), 'https://www.kanardia.eu');
        })
        .catch(error => {
            console.error('Error loading instrument layout:', error);
            alert('Error loading instrument layout data. Please try again.');
        });
}

/**
 * Save the current instrument layout data
 */
function saveInstrumentLayout() {
    if (!currentLayoutId || !isEditorLoaded) {
        alert('Editor not ready. Please wait for the editor to load.');
        return;
    }
    
    const iframe = document.getElementById('instrumentLayoutEditor');
    
    // Request data from the iframe
    iframe.contentWindow.postMessage({
        action: 'getData'
    }, 'https://www.kanardia.eu');
    
    // Listen for the response
    function handleSaveResponse(event) {
        if (event.origin !== 'https://www.kanardia.eu') return;
        
        if (event.data && event.data.action === 'dataResponse') {
            // Get CSRF token from meta tag
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Save to your backend
            fetch(`/dashboard/api/instrument-layout/${currentLayoutId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(event.data.data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal and refresh page
                if (modalInstance) {
                    modalInstance.hide();
                }
                location.reload();
            })
            .catch(error => {
                console.error('Error saving instrument layout:', error);
                alert('Error saving instrument layout. Please try again.');
            });
            
            // Remove the event listener
            window.removeEventListener('message', handleSaveResponse);
        }
    }
    
    window.addEventListener('message', handleSaveResponse);
}

/**
 * Save instrument layout data directly (for autosave functionality)
 * @param {Object} data - The layout data to save
 */
function saveInstrumentLayoutData(data) {
    if (!currentLayoutId) {
        console.error('No layout ID available for saving');
        return;
    }
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Save to backend API
    fetch(`/dashboard/api/instrument-layout/${currentLayoutId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            json_content: data
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('Instrument layout autosaved successfully:', result);
    })
    .catch(error => {
        console.error('Error autosaving instrument layout:', error);
    });
}

/**
 * Duplicate an instrument layout
 * @param {number} layoutId - The ID of the layout to duplicate
 */
function duplicateInstrumentLayout(layoutId) {
    if (confirm('Are you sure you want to duplicate this instrument layout?')) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/dashboard/api/instrument-layout/${layoutId}/duplicate`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error duplicating instrument layout:', error);
            alert('Error duplicating instrument layout. Please try again.');
        });
    }
}

/**
 * Delete an instrument layout
 * @param {number} layoutId - The ID of the layout to delete
 */
function deleteInstrumentLayout(layoutId) {
    if (confirm('Are you sure you want to delete this instrument layout? This action cannot be undone.')) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/dashboard/api/instrument-layout/${layoutId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error deleting instrument layout:', error);
            alert('Error deleting instrument layout. Please try again.');
        });
    }
}
</script>

<style>
.layout-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.layout-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
}

.page-header h1 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    color: #333;
}

.modal-fullscreen .modal-body {
    padding: 0;
}

#instrumentLayoutEditor {
    width: 100%;
    height: calc(100vh - 200px);
    border: none;
}

#editorLoading {
    background: #f8f9fa;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
    color: var(--kanardia-orange);
}

.spinner-border.text-primary {
    color: var(--kanardia-orange) !important;
}
</style>
{% endblock %}
