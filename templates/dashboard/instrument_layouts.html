{% extends "base.html" %}

{% block content %}
<!-- CSRF token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="page-header">
    <h1><span class="material-icons">dashboard</span> Instrument Layouts</h1>
    <div class="d-flex gap-2">
        <a href="{{ url_for('dashboard.import_instrument_layout') }}" class="btn btn-outline-primary">
            <span class="material-icons me-2">upload_file</span> Import Layout
        </a>
        <a href="{{ url_for('dashboard.add_instrument_layout') }}" class="btn btn-primary">
            <span class="material-icons me-2">add_circle</span> Create Layout
        </a>
    </div>
</div>

<!-- Instrument Layout Editor Modal -->
<div class="modal fade" id="instrumentLayoutEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-icons me-2">edit</span>
                    Instrument Layout Editor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Iframe with deferred loading - no initial src attribute -->
                <iframe 
                    id="instrumentLayoutEditor" 
                    data-src="https://www.kanardia.eu/apps/Customizer"
                    width="100%" 
                    height="100%" 
                    style="border: none; min-height: 80vh; display: none;">
                </iframe>
                <!-- Loading indicator -->
                <div id="editorLoading" class="d-flex justify-content-center align-items-center" style="height: 80vh;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">Loading Instrument Layout Editor...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span class="material-icons me-1">close</span> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="saveInstrumentLayout()">
                    <span class="material-icons me-1">save</span> Save Layout
                </button>
            </div>
        </div>
    </div>
</div>

{% if layouts %}
    <div class="row g-4">
        {% for layout in layouts %}
        <div class="col-lg-4 col-md-6">
            <div class="card layout-card">
                {% if layout.thumbnail_base64 %}
                    <img src="{{ layout.thumbnail_data_uri }}" 
                         class="card-img-top layout-thumbnail" 
                         alt="{{ layout.title }} thumbnail"
                         style="height: 200px; object-fit: contain; background-color: #f8f9fa;">
                {% elif layout.thumbnail_filename %}
                    <!-- Backward compatibility for file-based thumbnails -->
                    <img src="{{ url_for('dashboard.serve_thumbnail', filename=layout.thumbnail_filename) }}" 
                         class="card-img-top layout-thumbnail" 
                         alt="{{ layout.title }} thumbnail"
                         style="height: 200px; object-fit: contain; background-color: #f8f9fa;">
                {% else %}
                    <div class="card-img-top layout-placeholder d-flex align-items-center justify-content-center" 
                         style="height: 200px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <span class="material-icons" style="font-size: 4rem; color: #adb5bd;">dashboard</span>
                    </div>
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">
                        <span class="material-icons me-2" style="color: var(--kanardia-orange);">dashboard</span>
                        {{ layout.title }}
                    </h5>
                    <h6 class="card-subtitle mb-3">
                        <span class="badge" style="background: var(--kanardia-orange); color: white;">
                            {% if layout.instrument_type == 'digi' %}Digi
                            {% elif layout.instrument_type == 'indu_57mm' %}Indu 57mm
                            {% elif layout.instrument_type == 'indu_80mm' %}Indu 80mm
                            {% elif layout.instrument_type == 'altimeter_80mm' %}Altimeter 80mm
                            {% else %}{{ layout.instrument_type.title() }}
                            {% endif %}
                        </span>
                    </h6>
                    
                    {% if layout.description %}
                        <p class="card-text">{{ layout.description[:100] }}{% if layout.description|length > 100 %}...{% endif %}</p>
                    {% endif %}
                    
                    <p class="card-text">
                        <small class="text-muted">
                            <span class="material-icons me-1" style="font-size: 1rem; vertical-align: middle;">schedule</span>
                            Created {{ layout.created_at.strftime(current_user.date_format) }}
                        </small>
                    </p>
                    
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-primary btn-sm" onclick="openInstrumentLayoutEditor({{ layout.id }}, '{{ layout.title }}')">
                            <span class="material-icons me-1">edit</span> Edit
                        </button>
                        <a href="{{ url_for('dashboard.export_instrument_layout', layout_id=layout.id) }}" class="btn btn-outline-success btn-sm">
                            <span class="material-icons me-1">download</span> Export
                        </a>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown">
                                <span class="material-icons">more_vert</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="duplicateInstrumentLayout({{ layout.id }})">
                                        <span class="material-icons me-2">content_copy</span> Duplicate
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="renameInstrumentLayout({{ layout.id }}, '{{ layout.title }}', '{{ layout.description or '' }}')">
                                        <span class="material-icons me-2">edit</span> Rename
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="shareInstrumentLayout({{ layout.id }}, '{{ layout.title }}')">
                                        <span class="material-icons me-2">share</span> Share
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" onclick="deleteInstrumentLayout({{ layout.id }})">
                                        <span class="material-icons me-2">delete</span> Delete
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center mt-5">
        <span class="material-icons mb-4" style="font-size: 6rem; color: #e0e0e0;">dashboard</span>
        <h3 class="text-muted mb-3">No instrument layouts yet</h3>
        <p class="text-muted mb-4">Create your first instrument layout to get started with the Kanardia layout editor.</p>
        <a href="{{ url_for('dashboard.add_instrument_layout') }}" class="btn btn-primary btn-lg">
            <span class="material-icons me-2">add_circle</span> Create Your First Layout
        </a>
    </div>
{% endif %}

<!-- Rename Layout Modal -->
<div class="modal fade" id="renameLayoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-icons me-2">edit</span>
                    Edit Instrument Layout
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="renameLayoutForm">
                    <input type="hidden" id="renameLayoutId" value="">
                    <div class="mb-3">
                        <label for="renameLayoutTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="renameLayoutTitle" required maxlength="200" placeholder="Enter layout title...">
                    </div>
                    <div class="mb-3">
                        <label for="renameLayoutDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="renameLayoutDescription" rows="3" maxlength="500" placeholder="Describe the purpose or configuration of this instrument layout..."></textarea>
                        <div class="form-text">Optional description to help identify and organize your instrument layouts</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span class="material-icons me-1">close</span> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="submitRenameLayout()">
                    <span class="material-icons me-1">save</span> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Share Layout Modal -->
<div class="modal fade" id="shareLayoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-icons me-2">share</span>
                    Share Instrument Layout
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="text-muted">Choose how you'd like to share this instrument layout:</p>
                </div>
                
                <form id="shareLayoutForm">
                    <input type="hidden" id="shareLayoutId" value="">
                    <input type="hidden" id="shareLayoutTitle" value="">
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="shareType" id="shareToKanardia" value="kanardia" checked>
                            <label class="form-check-label" for="shareToKanardia">
                                <strong>Send to Kanardia</strong>
                                <div class="text-muted small">Share with Kanardia team (sales@kanardia.eu)</div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="shareType" id="shareToSelf" value="self">
                            <label class="form-check-label" for="shareToSelf">
                                <strong>Send to my email</strong>
                                <div class="text-muted small">Send to {{ current_user.email }}</div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="shareType" id="shareToCustom" value="custom">
                            <label class="form-check-label" for="shareToCustom">
                                <strong>Send to custom email</strong>
                            </label>
                        </div>
                        <div class="mt-2" id="customEmailGroup" style="display: none;">
                            <input type="email" class="form-control" id="customEmail" placeholder="Enter email address..." maxlength="254">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shareMessage" class="form-label">Message (Optional)</label>
                        <textarea class="form-control" id="shareMessage" rows="3" maxlength="500" placeholder="Add a message to include with the shared layout..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span class="material-icons me-1">close</span> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="submitShareLayout()">
                    <span class="material-icons me-1">send</span> Share Layout
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentLayoutId = null;
let isEditorLoaded = false;
let modalInstance = null;

/**
 * Handle messages received from the instrument layout editor iframe
 * @param {MessageEvent} event - The message event from the iframe
 */
function handleEditorMessage(event) {
    console.log('Instrument layout editor message:', event.data);

    if (event.origin !== 'https://www.kanardia.eu') {
        return; // Ignore messages from other origins
    }
    
    if (event.data && event.data.length > 0) {
        try {
            var payload = JSON.parse(event.data);
            if (payload.event === 'init') {
                isEditorLoaded = true;
                hideLoadingIndicator();
                // Call load method after init is received
                loadInstrumentLayoutData();
            }
            else if (payload.event === 'autosave') {
                saveInstrumentLayoutData(payload.xml);
            }
        } catch (error) {
            console.error('Error parsing editor message:', error);
        }
    }
}

/**
 * Open the instrument layout editor modal and load the iframe
 * @param {number} layoutId - The ID of the layout to edit
 * @param {string} layoutTitle - The title of the layout
 */
function openInstrumentLayoutEditor(layoutId, layoutTitle) {
    currentLayoutId = layoutId;
    isEditorLoaded = false;
    
    // Update modal title
    document.querySelector('#instrumentLayoutEditorModal .modal-title').innerHTML = 
        '<span class="material-icons me-2">edit</span>Edit: ' + layoutTitle;
    
    // Show loading indicator
    showLoadingIndicator();
    hideLoadingIndicator();

    // Add event listener for iframe messages
    window.addEventListener('message', handleEditorMessage);

    // Load the iframe source (deferred loading)
    const iframe = document.getElementById('instrumentLayoutEditor');
    const editorUrl = iframe.getAttribute('data-src');
    iframe.src = editorUrl;

    // Show the modal
    modalInstance = new bootstrap.Modal(document.getElementById('instrumentLayoutEditorModal'));
    modalInstance.show();

    // Handle modal close event to cleanup
    const modalElement = document.getElementById('instrumentLayoutEditorModal');
    modalElement.addEventListener('hidden.bs.modal', function onModalHidden() {
        // First, try to get thumbnail from editor before cleanup
        if (isEditorLoaded && currentLayoutId) {
            exportThumbnailFromEditor(() => {
                cleanupEditor();
            });
        } else {
            cleanupEditor();
        }
        modalElement.removeEventListener('hidden.bs.modal', onModalHidden);
    });
}

/**
 * Show the loading indicator and hide the iframe
 */
function showLoadingIndicator() {
    const loadingElement = document.getElementById('editorLoading');
    const iframe = document.getElementById('instrumentLayoutEditor');
    
    if (loadingElement) loadingElement.style.display = 'flex';
    if (iframe) iframe.style.display = 'none';
}

/**
 * Hide the loading indicator and show the iframe
 */
function hideLoadingIndicator() {
    const loadingElement = document.getElementById('editorLoading');
    const iframe = document.getElementById('instrumentLayoutEditor');
    
    if (loadingElement) loadingElement.style.display = 'none';
    if (iframe) iframe.style.display = 'block';
}

/**
 * Export thumbnail from editor before closing
 * @param {Function} callback - Callback function to execute after export
 */
function exportThumbnailFromEditor(callback) {
    const iframe = document.getElementById('instrumentLayoutEditor');
    
    if (!iframe || !iframe.contentWindow) {
        callback();
        return;
    }
    
    // Set up timeout to avoid hanging if editor doesn't respond
    const timeout = setTimeout(() => {
        console.warn('Thumbnail export timeout - proceeding with cleanup');
        window.removeEventListener('message', handleExportResponse);
        callback();
    }, 3000); // 3 second timeout
    
    // Listen for export response
    function handleExportResponse(event) {
        if (event.origin !== 'https://www.kanardia.eu') return;
        
        try {
            let payload;
            if (typeof event.data === 'string') {
                payload = JSON.parse(event.data);
            } else {
                payload = event.data;
            }
            
            if (payload.event === 'export' && payload.data) {
                clearTimeout(timeout);
                window.removeEventListener('message', handleExportResponse);
                
                // Save thumbnail to backend
                saveThumbnailToBackend(payload.data, callback);
            }
        } catch (error) {
            console.error('Error parsing export response:', error);
            clearTimeout(timeout);
            window.removeEventListener('message', handleExportResponse);
            callback();
        }
    }
    
    window.addEventListener('message', handleExportResponse);
    
    // Request export from iframe
    try {
        iframe.contentWindow.postMessage(JSON.stringify({
            action: 'export'
        }), 'https://www.kanardia.eu');
    } catch (error) {
        console.error('Error sending export message:', error);
        clearTimeout(timeout);
        window.removeEventListener('message', handleExportResponse);
        callback();
    }
}

/**
 * Save thumbnail data to backend
 * @param {string} thumbnailData - Base64 encoded PNG data with "png," prefix
 * @param {Function} callback - Callback function to execute after save
 */
function saveThumbnailToBackend(thumbnailData, callback) {
    if (!currentLayoutId) {
        callback();
        return;
    }
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Save thumbnail to backend
    fetch(`/dashboard/api/instrument-layout/${currentLayoutId}/thumbnail`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            thumbnail: thumbnailData
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('Thumbnail saved successfully:', result);
        
        // For base64 thumbnails, we need to reload the page to get updated data
        // since the thumbnail is now stored in the database
        if (result.has_thumbnail) {
            // Add a small delay and fade effect before reloading
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }
        
        callback();
    })
    .catch(error => {
        console.error('Error saving thumbnail:', error);
        callback(); // Still proceed with cleanup even if thumbnail save fails
    });
}

/**
 * Refresh a specific layout card with new thumbnail
 * @param {number} layoutId - The ID of the layout to refresh
 * @param {string} thumbnailFilename - The new thumbnail filename
 */
function refreshLayoutCard(layoutId, thumbnailFilename) {
    // Find the layout card by looking for the edit button with the layout ID
    const editButton = document.querySelector(`button[onclick*="openInstrumentLayoutEditor(${layoutId}"]`);
    if (!editButton) {
        console.warn(`Could not find layout card for ID ${layoutId}`);
        return;
    }
    
    // Navigate up to find the card element
    const card = editButton.closest('.card');
    if (!card) {
        console.warn(`Could not find card element for layout ${layoutId}`);
        return;
    }
    
    // Find the thumbnail/placeholder element
    const thumbnailElement = card.querySelector('.card-img-top');
    if (!thumbnailElement) {
        console.warn(`Could not find thumbnail element for layout ${layoutId}`);
        return;
    }
    
    // Create new thumbnail URL
    const thumbnailUrl = `/dashboard/thumbnails/instrument_layouts/${thumbnailFilename}`;
    
    // Replace placeholder with actual thumbnail or update existing thumbnail
    if (thumbnailElement.classList.contains('layout-placeholder')) {
        // Replace placeholder div with img element
        const newImg = document.createElement('img');
        newImg.src = thumbnailUrl;
        newImg.className = 'card-img-top layout-thumbnail';
        newImg.alt = 'Layout thumbnail';
        newImg.style.cssText = 'height: 200px; object-fit: contain; background-color: #f8f9fa;';
        
        // Add fade-in effect
        newImg.style.opacity = '0';
        thumbnailElement.parentNode.replaceChild(newImg, thumbnailElement);
        
        // Fade in the new thumbnail
        setTimeout(() => {
            newImg.style.transition = 'opacity 0.3s ease';
            newImg.style.opacity = '1';
        }, 50);
    } else if (thumbnailElement.tagName === 'IMG') {
        // Update existing image with cache-busting timestamp
        const cacheBuster = Date.now();
        thumbnailElement.style.transition = 'opacity 0.3s ease';
        thumbnailElement.style.opacity = '0.5';
        
        setTimeout(() => {
            thumbnailElement.src = `${thumbnailUrl}?v=${cacheBuster}`;
            thumbnailElement.style.opacity = '1';
        }, 150);
    }
    
    console.log(`Refreshed layout card ${layoutId} with new thumbnail: ${thumbnailFilename}`);
}

/**
 * Clean up editor resources when modal is closed
 */
function cleanupEditor() {
    // Remove event listener
    window.removeEventListener('message', handleEditorMessage);
    
    // Clear iframe source to stop loading
    const iframe = document.getElementById('instrumentLayoutEditor');
    if (iframe) {
        iframe.src = 'about:blank';
    }
    
    // Reset state
    currentLayoutId = null;
    isEditorLoaded = false;
    modalInstance = null;
    
    // Reset loading indicator
    showLoadingIndicator();
}

/**
 * Load instrument layout data from the backend and send to iframe
 */
function loadInstrumentLayoutData() {
    if (!currentLayoutId || !isEditorLoaded) return;
    
    // Get the iframe
    const iframe = document.getElementById('instrumentLayoutEditor');
    
    // Fetch layout data from your backend
    fetch(`/dashboard/api/instrument-layout/${currentLayoutId}/load_json`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Send data to the iframe
            iframe.contentWindow.postMessage(JSON.stringify({
                action: 'load', xml: data.content, title: data.title
            }), 'https://www.kanardia.eu');
        })
        .catch(error => {
            console.error('Error loading instrument layout:', error);
            alert('Error loading instrument layout data. Please try again.');
        });
}

/**
 * Save the current instrument layout data
 */
function saveInstrumentLayout() {
    if (!currentLayoutId || !isEditorLoaded) {
        alert('Editor not ready. Please wait for the editor to load.');
        return;
    }
    
    const iframe = document.getElementById('instrumentLayoutEditor');
    
    // Request data from the iframe
    iframe.contentWindow.postMessage({
        action: 'getData'
    }, 'https://www.kanardia.eu');
    
    // Listen for the response
    function handleSaveResponse(event) {
        if (event.origin !== 'https://www.kanardia.eu') return;
        
        if (event.data && event.data.action === 'dataResponse') {
            // Request thumbnail from iframe
            iframe.contentWindow.postMessage({
                action: 'getThumbnail',
                width: 300,
                height: 200
            }, 'https://www.kanardia.eu');
            
            // Wait for thumbnail response
            function handleThumbnailResponse(thumbnailEvent) {
                if (thumbnailEvent.origin !== 'https://www.kanardia.eu') return;
                
                if (thumbnailEvent.data && thumbnailEvent.data.action === 'thumbnailResponse') {
                    // Get CSRF token from meta tag
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    
                    // Prepare data for saving including thumbnail
                    const saveData = {
                        ...event.data.data,
                        thumbnail: thumbnailEvent.data.thumbnail
                    };
                    
                    // Save to your backend
                    fetch(`/dashboard/api/instrument-layout/${currentLayoutId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(saveData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Close modal and refresh page
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                        location.reload();
                    })
                    .catch(error => {
                        console.error('Error saving instrument layout:', error);
                        alert('Error saving instrument layout. Please try again.');
                    });
                    
                    // Remove event listeners
                    window.removeEventListener('message', handleThumbnailResponse);
                }
            }
            
            window.addEventListener('message', handleThumbnailResponse);
            
            // Remove the original event listener
            window.removeEventListener('message', handleSaveResponse);
        }
    }
    
    window.addEventListener('message', handleSaveResponse);
}

/**
 * Save instrument layout data directly (for autosave functionality)
 * @param {Object} data - The layout data to save
 */
function saveInstrumentLayoutData(data) {
    if (!currentLayoutId) {
        console.error('No layout ID available for saving');
        return;
    }
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Save to backend API
    fetch(`/dashboard/api/instrument-layout/${currentLayoutId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            xml_content: data
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('Instrument layout autosaved successfully:', result);
    })
    .catch(error => {
        console.error('Error autosaving instrument layout:', error);
    });
}

/**
 * Duplicate an instrument layout
 * @param {number} layoutId - The ID of the layout to duplicate
 */
function duplicateInstrumentLayout(layoutId) {
    if (confirm('Are you sure you want to duplicate this instrument layout?')) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/dashboard/api/instrument-layout/${layoutId}/duplicate`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error duplicating instrument layout:', error);
            alert('Error duplicating instrument layout. Please try again.');
        });
    }
}

/**
 * Delete an instrument layout
 * @param {number} layoutId - The ID of the layout to delete
 */
function deleteInstrumentLayout(layoutId) {
    if (confirm('Are you sure you want to delete this instrument layout? This action cannot be undone.')) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/dashboard/api/instrument-layout/${layoutId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error deleting instrument layout:', error);
            alert('Error deleting instrument layout. Please try again.');
        });
    }
}

/**
 * Rename an instrument layout
 * @param {number} layoutId - The ID of the layout to rename
 * @param {string} currentTitle - The current title of the layout
 * @param {string} currentDescription - The current description of the layout
 */
function renameInstrumentLayout(layoutId, currentTitle, currentDescription = '') {
    // Set modal values
    document.getElementById('renameLayoutId').value = layoutId;
    document.getElementById('renameLayoutTitle').value = currentTitle;
    document.getElementById('renameLayoutDescription').value = currentDescription;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('renameLayoutModal'));
    modal.show();
}

/**
 * Submit the rename layout form
 */
function submitRenameLayout() {
    const layoutId = document.getElementById('renameLayoutId').value;
    const title = document.getElementById('renameLayoutTitle').value;
    const description = document.getElementById('renameLayoutDescription').value;
    
    if (!title.trim()) {
        alert('Please enter a title for the layout.');
        return;
    }
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/dashboard/api/instrument-layout/${layoutId}/rename`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            title: title.trim(),
            description: description.trim()
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Hide modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('renameLayoutModal'));
        modal.hide();
        location.reload();
    })
    .catch(error => {
        console.error('Error renaming instrument layout:', error);
        alert('Error renaming instrument layout. Please try again.');
    });
}

/**
 * Open the share layout modal
 * @param {number} layoutId - The ID of the layout to share
 * @param {string} layoutTitle - The title of the layout
 */
function shareInstrumentLayout(layoutId, layoutTitle) {
    // Set modal values
    document.getElementById('shareLayoutId').value = layoutId;
    document.getElementById('shareLayoutTitle').value = layoutTitle;
    
    // Reset form
    document.getElementById('shareToKanardia').checked = true;
    document.getElementById('customEmail').value = '';
    document.getElementById('shareMessage').value = '';
    document.getElementById('customEmailGroup').style.display = 'none';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('shareLayoutModal'));
    modal.show();
}

/**
 * Submit the share layout form
 */
function submitShareLayout() {
    const layoutId = document.getElementById('shareLayoutId').value;
    const shareType = document.querySelector('input[name="shareType"]:checked').value;
    const customEmail = document.getElementById('customEmail').value;
    const message = document.getElementById('shareMessage').value;
    
    // Validation
    if (shareType === 'custom' && (!customEmail || !customEmail.trim())) {
        alert('Please enter a custom email address.');
        return;
    }
    
    // Validate email format for custom email
    if (shareType === 'custom') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(customEmail.trim())) {
            alert('Please enter a valid email address.');
            return;
        }
    }
    
    // Show loading state
    const submitBtn = document.querySelector('#shareLayoutModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="material-icons me-1 spinner-border spinner-border-sm" role="status"></span> Sending...';
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/dashboard/api/instrument-layout/${layoutId}/share`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            share_type: shareType,
            custom_email: customEmail.trim(),
            message: message.trim()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('shareLayoutModal'));
            modal.hide();
            
            // Show success message
            alert(data.message || 'Instrument layout shared successfully!');
        } else {
            throw new Error(data.message || 'Failed to share layout');
        }
    })
    .catch(error => {
        console.error('Error sharing instrument layout:', error);
        alert('Error sharing instrument layout: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Handle radio button changes for share type
document.addEventListener('DOMContentLoaded', function() {
    const shareTypeRadios = document.querySelectorAll('input[name="shareType"]');
    const customEmailGroup = document.getElementById('customEmailGroup');
    
    shareTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'custom') {
                customEmailGroup.style.display = 'block';
                document.getElementById('customEmail').focus();
            } else {
                customEmailGroup.style.display = 'none';
            }
        });
    });
});
</script>

<style>
.layout-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.layout-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.layout-thumbnail {
    transition: transform 0.3s ease;
    height: 200px;
    object-fit: contain;
    background-color: #f8f9fa;
    width: 100%;
}

.layout-card:hover .layout-thumbnail {
    transform: scale(1.05);
}

.layout-placeholder {
    transition: all 0.3s ease;
}

.layout-card:hover .layout-placeholder {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%) !important;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
}

.page-header h1 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    color: #333;
}

.modal-fullscreen .modal-body {
    padding: 0;
}

#instrumentLayoutEditor {
    width: 100%;
    height: calc(100vh - 200px);
    border: none;
}

#editorLoading {
    background: #f8f9fa;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
    color: var(--kanardia-orange);
}

.spinner-border.text-primary {
    color: var(--kanardia-orange) !important;
}
</style>
{% endblock %}
