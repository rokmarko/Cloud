{% extends "base.html" %}

{% block content %}
<!-- CSRF token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-user-pilot"></i> Pilot Mappings</h2>
                    <p class="text-muted mb-0">Manage pilot mappings for <strong>{{ device.name }}</strong> ({{ device.registration }})</p>
                </div>
                <div>
                    <a href="{{ url_for('dashboard.device_logbook', device_id=device.id) }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Back to Logbook
                    </a>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPilotModal">
                        <i class="fas fa-plus"></i> Add Pilot Mapping
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-pilot fa-2x me-3"></i>
                                <div>
                                    <h4 class="mb-0">{{ pilot_mappings.total }}</h4>
                                    <small>Mapped Pilots</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                                <div>
                                    <h4 class="mb-0">{{ unmapped_pilots|length }}</h4>
                                    <small>Unmapped Pilots</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-percentage fa-2x me-3"></i>
                                <div>
                                    <h4 class="mb-0">{{ (pilot_mappings.total / (pilot_mappings.total + unmapped_pilots|length) * 100)|round(1) if (pilot_mappings.total + unmapped_pilots|length) > 0 else 0 }}%</h4>
                                    <small>Coverage</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unmapped Pilots Alert -->
            {% if unmapped_pilots %}
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <div>
                        <strong>Unmapped Pilots Found:</strong> {{ unmapped_pilots|join(', ') }}
                        <br><small>These pilot names appear in your device's logbook but have no user mapping.</small>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Search -->
            {% if pilot_mappings.total > 0 %}
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" name="search" value="{{ search }}" 
                                   placeholder="Search pilot name or user email...">
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="fas fa-search"></i> Search
                                </button>
                                <a href="{{ url_for('dashboard.device_pilots', device_id=device.id) }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Pilot Mappings Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Current Pilot Mappings</h5>
                </div>
                <div class="card-body p-0">
                    {% if pilot_mappings.items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Pilot Name</th>
                                    <th>Mapped User</th>
                                    <th>Logbook Entries</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pilot in pilot_mappings.items %}
                                <tr>
                                    <td>
                                        <strong>{{ pilot.pilot_name }}</strong>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <strong>{{ pilot.user.nickname or pilot.user.email }}</strong><br>
                                                <small class="text-muted">{{ pilot.user.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% set entry_count = pilot.get_logbook_entry_count() %}
                                        {% if entry_count > 0 %}
                                            <span class="badge bg-success">{{ entry_count }} entries</span>
                                        {% else %}
                                            <span class="text-muted">No entries</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ pilot.created_at.strftime(current_user.date_format) if pilot.created_at else 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                data-pilot-id="{{ pilot.id }}"
                                                data-pilot-name="{{ pilot.pilot_name }}"
                                                data-user-email="{{ pilot.user.email }}"
                                                onclick="confirmDeletePilot(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if pilot_mappings.pages > 1 %}
                    <div class="card-footer">
                        <nav aria-label="Pilot mappings pagination">
                            <ul class="pagination justify-content-center mb-0">
                                {% if pilot_mappings.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('dashboard.device_pilots', device_id=device.id, page=pilot_mappings.prev_num, search=search) }}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                                {% endif %}
                                
                                {% for page_num in pilot_mappings.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != pilot_mappings.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('dashboard.device_pilots', device_id=device.id, page=page_num, search=search) }}">{{ page_num }}</a>
                                        </li>
                                        {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                        {% endif %}
                                    {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">…</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if pilot_mappings.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('dashboard.device_pilots', device_id=device.id, page=pilot_mappings.next_num, search=search) }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-user-pilot fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Pilot Mappings</h5>
                        <p class="text-muted">Create your first pilot mapping to link pilot names to user accounts.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPilotModal">
                            <i class="fas fa-plus"></i> Create First Mapping
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Pilot Mapping Modal -->
<div class="modal fade" id="createPilotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create Pilot Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('dashboard.create_device_pilot_mapping', device_id=device.id) }}">
                {{ form.hidden_tag() }}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Creating a pilot mapping for {{ device.name }}</strong><br>
                        <small>This will link a pilot name from logbook entries to a user account, allowing them to access this device's logbook.</small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.pilot_name.label(class="form-label") }}
                        {{ form.pilot_name(class="form-control", placeholder="Enter pilot name as it appears in logbook", autocomplete="off") }}
                        <div class="form-text">{{ form.pilot_name.description }}</div>
                        {% if form.pilot_name.errors %}
                            <div class="text-danger">
                                {% for error in form.pilot_name.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.user_email.label(class="form-label") }}
                        {{ form.user_email(class="form-control", placeholder="user@example.com") }}
                        <div class="form-text">{{ form.user_email.description }}</div>
                        {% if form.user_email.errors %}
                            <div class="text-danger">
                                {% for error in form.user_email.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    {% if unmapped_pilots %}
                    <div class="alert alert-warning">
                        <strong>Quick Select Unmapped Pilots:</strong>
                        <div class="mt-2">
                            {% for pilot_name in unmapped_pilots %}
                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                    data-pilot-name="{{ pilot_name }}"
                                    onclick="selectPilotName(this)">
                                {{ pilot_name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="fas fa-trash"></i> Delete Pilot Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this pilot mapping?</p>
                <div class="alert alert-warning">
                    <strong>Pilot:</strong> <span id="deletePilotName"></span><br>
                    <strong>User:</strong> <span id="deleteUserEmail"></span><br>
                    <strong>Device:</strong> {{ device.name }}
                </div>
                <p class="text-muted">This action cannot be undone. Logbook entries will no longer be linked to this user.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteForm" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">Delete Mapping</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDeletePilot(button) {
    const pilotId = button.dataset.pilotId;
    const pilotName = button.dataset.pilotName;
    const userEmail = button.dataset.userEmail;
    
    document.getElementById('deletePilotName').textContent = pilotName;
    document.getElementById('deleteUserEmail').textContent = userEmail;
    document.getElementById('deleteForm').action = '/dashboard/devices/{{ device.id }}/pilots/' + pilotId + '/delete';
    
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

function selectPilotName(button) {
    const pilotName = button.dataset.pilotName;
    document.getElementById('pilot_name').value = pilotName;
}

// Auto-complete for pilot names
document.addEventListener('DOMContentLoaded', function() {
    const pilotInput = document.getElementById('pilot_name');
    if (pilotInput) {
        // Add datalist for autocomplete
        const datalist = document.createElement('datalist');
        datalist.id = 'pilot_suggestions';
        pilotInput.setAttribute('list', 'pilot_suggestions');
        pilotInput.parentNode.appendChild(datalist);
        
        // Add input event listener
        pilotInput.addEventListener('input', function(e) {
            const query = e.target.value;
            
            if (query.length < 2) {
                datalist.innerHTML = '';
                return;
            }
            
            fetch(`/dashboard/api/devices/{{ device.id }}/pilots/suggestions?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(suggestions => {
                    datalist.innerHTML = '';
                    suggestions.forEach(suggestion => {
                        const option = document.createElement('option');
                        option.value = suggestion;
                        datalist.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching suggestions:', error));
        });
    }
});
</script>

{% endblock %}
