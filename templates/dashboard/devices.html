{% extends "base.html" %}

{% block content %}
<!-- CSRF token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-cpu"></i> My Devices</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('dashboard.add_device') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Device
        </a>
    </div>
</div>

{% if devices %}
    <div class="row">
        {% for device in devices %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title">
                                <i class="bi bi-{% if device.device_type == 'aircraft' %}airplane{% elif device.device_type == 'gyro' %}person-check{% elif device.device_type == 'helicopter' %}airplane-engines{% elif device.device_type == 'trike' %}bicycle{% else %}airplane{% endif %}"></i>
                                {{ device.name }}
                            </h5>
                            <h6 class="card-subtitle mb-2 text-muted">{{ device.device_type.title() }}</h6>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{{ url_for('dashboard.device_logbook', device_id=device.id) }}">
                                    <i class="bi bi-book"></i> View Logbook
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard.edit_device', device_id=device.id) }}">
                                    <i class="bi bi-pencil"></i> Edit
                                </a></li>
                                {% if device.external_device_id %}
                                <li>
                                    <a class="dropdown-item" href="#" onclick="syncTelemetry({{ device.id }})">
                                        <i class="bi bi-broadcast"></i> Sync Telemetry
                                    </a>
                                </li>
                                {% endif %}
                                <li>
                                    <a class="dropdown-item" href="#" onclick="duplicateDevice({{ device.id }})">
                                        <i class="bi bi-files"></i> Duplicate
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="POST" action="{{ url_for('dashboard.delete_device', device_id=device.id) }}" class="m-0">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Are you sure you want to delete this device?')">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    {% if device.model %}
                        <p class="card-text"><strong>Model:</strong> {{ device.model }}</p>
                    {% endif %}
                    {% if device.serial_number %}
                        <p class="card-text"><strong>Instrument:</strong> {{ device.serial_number }}</p>
                    {% endif %}
                    {% if device.registration %}
                        <p class="card-text"><strong>Registration:</strong> {{ device.registration }}</p>
                    {% endif %}
                    
                    <!-- Telemetry Information -->
                    {% if device.last_telemetry_update %}
                        <div class="mt-3 pt-3 border-top">
                            <h6 class="text-info mb-2">
                                <i class="bi bi-broadcast"></i> Telemetry Data
                                {% set age = device.get_telemetry_age() %}
                                <span class="badge ms-2 
                                    {% if 'Just now' in age or 'minute' in age %}bg-success
                                    {% elif 'hour' in age %}bg-warning
                                    {% elif 'day' in age %}bg-secondary
                                    {% else %}bg-dark
                                    {% endif %}" 
                                    title="{{ device.get_telemetry_timestamp() }}">
                                    {% if 'Just now' in age or 'minute' in age %}
                                        <i class="bi bi-wifi"></i>
                                    {% elif 'hour' in age %}
                                        <i class="bi bi-clock"></i>
                                    {% else %}
                                        <i class="bi bi-clock-history"></i>
                                    {% endif %}
                                    {{ age }}
                                </span>
                            </h6>
                            <div class="row">
                                {% if device.status_description %}
                                <div class="col-12 mb-2">
                                    <span class="badge 
                                        {% if device.status_description == 'Airborne' %}bg-warning
                                        {% elif device.status_description == 'Engine' %}bg-info
                                        {% elif device.status_description == 'Parked' %}bg-secondary
                                        {% else %}bg-light text-dark
                                        {% endif %}">
                                        {% if device.status_description == 'Airborne' %}
                                            <i class="bi bi-airplane"></i>
                                        {% elif device.status_description == 'Engine' %}
                                            <i class="bi bi-gear"></i>
                                        {% elif device.status_description == 'Parked' %}
                                            <i class="bi bi-pause-circle"></i>
                                        {% endif %}
                                        {{ device.status_description }}
                                    </span>
                                </div>
                                {% endif %}
                                {% if device.fuel_quantity is not none %}
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-fuel-pump"></i> Fuel: {{ "%.1f"|format(device.fuel_quantity) }} L
                                    </small>
                                </div>
                                {% endif %}
                                {% if device.location_description %}
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-geo-alt"></i> {{ device.location_description }}
                                    </small>
                                </div>
                                {% endif %}
                                {% if device.altitude is not none %}
                                <div class="col-6 mt-1">
                                    <small class="text-muted">
                                        <i class="bi bi-arrow-up"></i> {{ "%.0f"|format(device.altitude) }} ft
                                    </small>
                                </div>
                                {% endif %}
                                {% if device.speed is not none %}
                                <div class="col-6 mt-1">
                                    <small class="text-muted">
                                        <i class="bi bi-speedometer2"></i> {{ "%.0f"|format(device.speed) }} kt
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% elif device.external_device_id %}
                        <div class="mt-3 pt-3 border-top">
                            <small class="text-muted">
                                <i class="bi bi-broadcast"></i> No telemetry data available
                            </small>
                        </div>
                    {% endif %}
                    
                    <!-- Logbook Stats -->
                    <div class="mt-3 pt-3 border-top">
                        <div class="row text-center">
                            <div class="col-6">
                                <h6 class="text-primary mb-1">{{ device.logbook_entry_count }}</h6>
                                <small class="text-muted">Log Entries</small>
                            </div>
                            <div class="col-6">
                                <h6 class="text-success mb-1">{{ "%.1f"|format(device.total_flight_time) }}</h6>
                                <small class="text-muted">Flight Hours</small>
                            </div>
                        </div>
                        {% if device.logbook_entry_count > 0 %}
                        <div class="text-center mt-2">
                            <a href="{{ url_for('dashboard.device_logbook', device_id=device.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-book"></i> View Logbook
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    
                    <p class="card-text mt-3">
                        <small class="text-muted">Added {{ device.created_at.strftime(current_user.date_format) }}</small>
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center mt-5">
        <i class="bi bi-cpu display-1 text-muted mb-4"></i>
        <h3 class="text-muted">No devices yet</h3>
        <p class="text-muted">Start by adding your first device.</p>
        <a href="{{ url_for('dashboard.add_device') }}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle"></i> Add Your First Device
        </a>
    </div>
{% endif %}

<script>
/**
 * Duplicate a device
 * @param {number} deviceId - The ID of the device to duplicate
 */
function duplicateDevice(deviceId) {
    if (confirm('Are you sure you want to duplicate this device?')) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/api/device/${deviceId}/duplicate`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error duplicating device:', error);
            alert('Error duplicating device. Please try again.');
        });
    }
}

/**
 * Delete a device via API
 * @param {number} deviceId - The ID of the device to delete
 */
function deleteDeviceAPI(deviceId) {
    if (confirm('Are you sure you want to delete this device? This action cannot be undone.')) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/api/device/${deviceId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error deleting device:', error);
            alert('Error deleting device. Please try again.');
        });
    }
}

function syncTelemetry(deviceId) {
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Show loading indicator (you can enhance this with a better UI)
    const button = event.target.closest('a');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Syncing...';
    button.style.pointerEvents = 'none';
    
    fetch(`/api/device/${deviceId}/sync-telemetry`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success message
            alert('Telemetry synced successfully!');
            // Reload page to show updated telemetry
            location.reload();
        } else {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error syncing telemetry:', error);
        alert('Error syncing telemetry. Please try again.');
    })
    .finally(() => {
        // Restore button
        button.innerHTML = originalText;
        button.style.pointerEvents = 'auto';
    });
}
</script>

{% endblock %}
