{% extends "base.html" %}

{% block content %}
<!-- CSRF token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="page-header">
    <h1><span class="material-icons">checklist</span> Checklists</h1>
    <div class="d-flex gap-2">
        <a href="{{ url_for('dashboard.import_checklist') }}" class="btn btn-outline-primary">
            <span class="material-icons me-2">upload_file</span> Import Checklist
        </a>
        <a href="{{ url_for('dashboard.add_checklist') }}" class="btn btn-primary">
            <span class="material-icons me-2">add_circle</span> Create Checklist
        </a>
    </div>
</div>

<!-- Checklist Editor Modal -->
<div class="modal fade" id="checklistEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-icons me-2">edit</span>
                    Checklist Editor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Iframe with deferred loading - no initial src attribute -->
                    <!-- data-src="http://localhost:30000/" -->
                <iframe 
                    id="checklistEditor" 
                    data-src="https://www.kanardia.eu/apps/checklist"
                    width="100%" 
                    height="100%" 
                    style="border: none; min-height: 80vh; display: none;">
                </iframe>
                <!-- Loading indicator -->
                <div id="editorLoading" class="d-flex justify-content-center align-items-center" style="height: 80vh;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">Loading Checklist Editor...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span class="material-icons me-1">close</span> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="saveChecklist()">
                    <span class="material-icons me-1">save</span> Save Checklist
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Send To Device Modal -->
<div class="modal fade" id="sendToModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-icons me-2">send</span>
                    Send Checklist to Device
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Checklist:</label>
                    <div class="form-control-plaintext" id="sendChecklistTitle">
                        <strong id="sendChecklistName"></strong>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="deviceSelect" class="form-label">Select Device:</label>
                    <select class="form-select" id="deviceSelect">
                        <option value="">Loading devices...</option>
                    </select>
                    <div class="form-text">
                        You can send to your own devices or devices where you are mapped as a pilot.
                    </div>
                </div>
                
                <div id="sendError" class="alert alert-danger d-none"></div>
                <div id="sendSuccess" class="alert alert-success d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span class="material-icons me-1">close</span> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="sendChecklistToDevice()" id="sendButton">
                    <span class="material-icons me-1">send</span> Send Checklist
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rename Checklist Modal -->
<div class="modal fade" id="renameChecklistModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-icons me-2">edit</span>
                    Edit Checklist
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="renameChecklistForm">
                    <input type="hidden" id="renameChecklistId" value="">
                    <div class="mb-3">
                        <label for="renameChecklistTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="renameChecklistTitle" required maxlength="200" placeholder="Enter checklist title...">
                    </div>
                    <div class="mb-3">
                        <label for="renameChecklistDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="renameChecklistDescription" rows="3" maxlength="500" placeholder="Describe the purpose or usage of this checklist..."></textarea>
                        <div class="form-text">Optional description to help identify and organize your checklists</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span class="material-icons me-1">close</span> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="submitRenameChecklist()">
                    <span class="material-icons me-1">save</span> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

{% if checklists %}
    <div class="row g-4">
        {% for checklist in checklists %}
        <div class="col-lg-4 col-md-6">
            <div class="card checklist-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <span class="material-icons me-2" style="color: var(--kanardia-orange);">checklist</span>
                        {{ checklist.title }}
                    </h5>
                    
                    {% if checklist.description %}
                        <p class="card-text">{{ checklist.description[:100] }}{% if checklist.description|length > 100 %}...{% endif %}</p>
                    {% endif %}
                    
                    <p class="card-text">
                        <small class="text-muted">
                            <span class="material-icons me-1" style="font-size: 1rem; vertical-align: middle;">schedule</span>
                            Created {{ checklist.created_at.strftime('%m/%d/%Y') }}
                            {% if checklist.updated_at and checklist.updated_at > checklist.created_at %}
                            <br>
                            <span class="material-icons me-1" style="font-size: 1rem; vertical-align: middle;">update</span>
                            Modified {{ checklist.updated_at.strftime('%m/%d/%Y at %H:%M') }}
                            {% endif %}
                        </small>
                    </p>
                    
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-primary btn-sm" onclick="openChecklistEditor({{ checklist.id }}, '{{ checklist.title }}')">
                            <span class="material-icons me-1">edit</span> Edit
                        </button>
                        <a href="{{ url_for('dashboard.export_checklist', checklist_id=checklist.id) }}" class="btn btn-outline-success btn-sm">
                            <span class="material-icons me-1">download</span> Export
                        </a>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown">
                                <span class="material-icons">more_vert</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="showSendToModal({{ checklist.id }}, '{{ checklist.title }}')">
                                        <span class="material-icons me-2">send</span> Send To Device
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="renameChecklist({{ checklist.id }}, '{{ checklist.title }}', '{{ checklist.description or '' }}')">
                                        <span class="material-icons me-2">edit</span> Rename
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="duplicateChecklist({{ checklist.id }})">
                                        <span class="material-icons me-2">content_copy</span> Duplicate
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" onclick="deleteChecklist({{ checklist.id }})">
                                        <span class="material-icons me-2">delete</span> Delete
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center mt-5">
        <span class="material-icons mb-4" style="font-size: 6rem; color: #e0e0e0;">checklist</span>
        <h3 class="text-muted mb-3">No checklists yet</h3>
        <p class="text-muted mb-4">Create your first checklist to get started with the Kanardia editor.</p>
        <a href="{{ url_for('dashboard.add_checklist') }}" class="btn btn-primary btn-lg">
            <span class="material-icons me-2">add_circle</span> Create Your First Checklist
        </a>
    </div>
{% endif %}

<script>
let currentChecklistId = null;
let isEditorLoaded = false;
let modalInstance = null;

/**
 * Handle messages received from the checklist editor iframe
 * @param {MessageEvent} event - The message event from the iframe
 */
function handleEditorMessage(event) {
    console.log('Checklist editor message:', event.data);

    if (event.origin !== 'https://www.kanardia.eu') {
        return; // Ignore messages from other origins
    }
    
    if (event.data && event.data.length > 0) {
        try {
            var payload = JSON.parse(event.data);
            if (payload.event === 'init') {
                isEditorLoaded = true;
                hideLoadingIndicator();
                // Call load method after init is received
                loadChecklistData();
            }
            else if (payload.event === 'autosave') {
                saveChecklistData(payload.xml);
            }
        } catch (error) {
            console.error('Error parsing editor message:', error);
        }
    }
}

/**
 * Open the checklist editor modal and load the iframe
 * @param {number} checklistId - The ID of the checklist to edit
 * @param {string} checklistTitle - The title of the checklist
 */
function openChecklistEditor(checklistId, checklistTitle) {
    currentChecklistId = checklistId;
    isEditorLoaded = false;
    
    // Update modal title
    document.querySelector('#checklistEditorModal .modal-title').innerHTML = 
        '<span class="material-icons me-2">edit</span>Edit: ' + checklistTitle;
    
    // Show loading indicator
    showLoadingIndicator();

    // Add event listener for iframe messages
    window.addEventListener('message', handleEditorMessage);

    // Load the iframe source (deferred loading)
    const iframe = document.getElementById('checklistEditor');
    const editorUrl = iframe.getAttribute('data-src');
    iframe.src = editorUrl;

    // Show the modal
    modalInstance = new bootstrap.Modal(document.getElementById('checklistEditorModal'));
    modalInstance.show();
   
    // Handle modal close event to cleanup
    const modalElement = document.getElementById('checklistEditorModal');
    modalElement.addEventListener('hidden.bs.modal', function onModalHidden() {
        cleanupEditor();
        modalElement.removeEventListener('hidden.bs.modal', onModalHidden);
    });
}

/**
 * Show the loading indicator and hide the iframe
 */
function showLoadingIndicator() {
    const loadingElement = document.getElementById('editorLoading');
    const iframe = document.getElementById('checklistEditor');
    
    if (loadingElement) loadingElement.style.display = 'flex';
    if (iframe) iframe.style.display = 'none';
}

/**
 * Hide the loading indicator and show the iframe
 */
function hideLoadingIndicator() {
    const loadingElement = document.getElementById('editorLoading');
    const iframe = document.getElementById('checklistEditor');
    
    if (loadingElement) loadingElement.style.display = 'none';
    if (iframe) iframe.style.display = 'block';
}

/**
 * Clean up editor resources when modal is closed
 */
function cleanupEditor() {
    // Remove event listener
    window.removeEventListener('message', handleEditorMessage);
    
    // Clear iframe source to stop loading
    const iframe = document.getElementById('checklistEditor');
    if (iframe) {
        iframe.src = 'about:blank';
    }
    
    // Reset state
    currentChecklistId = null;
    isEditorLoaded = false;
    modalInstance = null;
    
    // Reset loading indicator
    showLoadingIndicator();
}

/**
 * Load checklist data from the backend and send to iframe
 */
function loadChecklistData() {
    if (!currentChecklistId || !isEditorLoaded) return;
    
    // Get the iframe
    const iframe = document.getElementById('checklistEditor');
    
    // Fetch checklist data from your backend
    fetch(`/dashboard/api/checklist/${currentChecklistId}/load_json`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(reply => {
            // Send data to the iframe
            iframe.contentWindow.postMessage(JSON.stringify({
                action: 'load', xml: reply.data, title: reply.title
            }), 'https://www.kanardia.eu');
        })
        .catch(error => {
            console.error('Error loading checklist:', error);
            alert('Error loading checklist data. Please try again.');
        });
}

/**
 * Save the current checklist data
 */
function saveChecklist() {
    if (!currentChecklistId || !isEditorLoaded) {
        alert('Editor not ready. Please wait for the editor to load.');
        return;
    }
    
    const iframe = document.getElementById('checklistEditor');
    
    // Request data from the iframe
    iframe.contentWindow.postMessage({
        action: 'getData'
    }, 'https://www.kanardia.eu');
    
    // Listen for the response
    function handleSaveResponse(event) {
        if (event.origin !== 'https://www.kanardia.eu') return;
        
        if (event.data && event.data.action === 'dataResponse') {
            // Get CSRF token from meta tag
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Save to your backend
            fetch(`/dashboard/api/checklist/${currentChecklistId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(event.data.data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal and refresh page
                if (modalInstance) {
                    modalInstance.hide();
                }
                location.reload();
            })
            .catch(error => {
                console.error('Error saving checklist:', error);
                alert('Error saving checklist. Please try again.');
            });
            
            // Remove the event listener
            window.removeEventListener('message', handleSaveResponse);
        }
    }
    
    window.addEventListener('message', handleSaveResponse);
}

/**
 * Save checklist data directly (for autosave functionality)
 * @param {Object} data - The checklist data to save
 */
function saveChecklistData(data) {
    if (!currentChecklistId) {
        console.error('No checklist ID available for saving');
        return;
    }
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Save to backend API
    fetch(`/dashboard/api/checklist/${currentChecklistId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            json_content: data
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('Checklist autosaved successfully:', result);
        // Optional: Show a subtle notification that data was saved
        // You could add a small "Saved" indicator here
    })
    .catch(error => {
        console.error('Error autosaving checklist:', error);
        // Don't show alert for autosave failures as they can be disruptive
        // Instead, log the error for debugging
    });
}

/**
 * Duplicate a checklist
 * @param {number} checklistId - The ID of the checklist to duplicate
 */
function duplicateChecklist(checklistId) {
    if (confirm('Are you sure you want to duplicate this checklist?')) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/dashboard/api/checklist/${checklistId}/duplicate`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error duplicating checklist:', error);
            alert('Error duplicating checklist. Please try again.');
        });
    }
}

/**
 * Delete a checklist
 * @param {number} checklistId - The ID of the checklist to delete
 */
function deleteChecklist(checklistId) {
    if (confirm('Are you sure you want to delete this checklist? This action cannot be undone.')) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/dashboard/api/checklist/${checklistId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error deleting checklist:', error);
            alert('Error deleting checklist. Please try again.');
        });
    }
}

function renameChecklist(checklistId, currentTitle = '', currentDescription = '') {
    // Get current values from the page
    const checklistCard = document.querySelector(`[data-checklist-id="${checklistId}"]`);
    if (checklistCard) {
        const titleElement = checklistCard.querySelector('.card-title');
        const descElement = checklistCard.querySelector('.text-muted');
        currentTitle = titleElement ? titleElement.textContent.trim() : currentTitle;
        currentDescription = descElement ? descElement.textContent.replace('Description: ', '').trim() : currentDescription;
    }
    
    // Show rename modal
    document.getElementById('renameChecklistTitle').value = currentTitle;
    document.getElementById('renameChecklistDescription').value = currentDescription || '';
    document.getElementById('renameChecklistId').value = checklistId;
    
    const modal = new bootstrap.Modal(document.getElementById('renameChecklistModal'));
    modal.show();
}

function submitRenameChecklist() {
    const checklistId = document.getElementById('renameChecklistId').value;
    const newTitle = document.getElementById('renameChecklistTitle').value.trim();
    const newDescription = document.getElementById('renameChecklistDescription').value.trim();
    
    if (!newTitle) {
        alert('Title cannot be empty');
        return;
    }
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/dashboard/api/checklist/${checklistId}/rename`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            title: newTitle,
            description: newDescription
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('renameChecklistModal')).hide();
        location.reload();
    })
    .catch(error => {
        console.error('Error updating checklist:', error);
        alert('Error updating checklist. Please try again.');
    });
}

let currentChecklistToSend = null;

/**
 * Show the Send To modal and load devices
 * @param {number} checklistId - The ID of the checklist to send
 * @param {string} checklistTitle - The title of the checklist
 */
function showSendToModal(checklistId, checklistTitle) {
    currentChecklistToSend = checklistId;
    
    // Set checklist name in modal
    document.getElementById('sendChecklistName').textContent = checklistTitle;
    
    // Reset modal state
    document.getElementById('sendError').classList.add('d-none');
    document.getElementById('sendSuccess').classList.add('d-none');
    document.getElementById('sendButton').disabled = false;
    
    // Load devices
    loadAvailableDevices();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('sendToModal'));
    modal.show();
}

/**
 * Load devices that the user can send checklists to
 */
function loadAvailableDevices() {
    const deviceSelect = document.getElementById('deviceSelect');
    deviceSelect.innerHTML = '<option value="">Loading devices...</option>';
    
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch('/dashboard/api/available-devices', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        deviceSelect.innerHTML = '';
        
        if (data.devices && data.devices.length > 0) {
            deviceSelect.innerHTML = '<option value="">Select a device...</option>';
            
            data.devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = `${device.name} (${device.type}) ${device.ownership}`;
                deviceSelect.appendChild(option);
            });
        } else {
            deviceSelect.innerHTML = '<option value="">No devices available</option>';
        }
    })
    .catch(error => {
        console.error('Error loading devices:', error);
        deviceSelect.innerHTML = '<option value="">Error loading devices</option>';
    });
}

/**
 * Send checklist to selected device
 */
function sendChecklistToDevice() {
    const deviceId = document.getElementById('deviceSelect').value;
    const errorDiv = document.getElementById('sendError');
    const successDiv = document.getElementById('sendSuccess');
    const sendButton = document.getElementById('sendButton');
    
    // Reset alerts
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');
    
    if (!deviceId) {
        errorDiv.textContent = 'Please select a device.';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    if (!currentChecklistToSend) {
        errorDiv.textContent = 'No checklist selected.';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    // Disable send button
    sendButton.disabled = true;
    sendButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
    
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/dashboard/api/checklist/${currentChecklistToSend}/send`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: parseInt(deviceId)
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        successDiv.textContent = data.message || 'Checklist sent successfully!';
        successDiv.classList.remove('d-none');
        
        // Close modal after 2 seconds
        setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('sendToModal'));
            modal.hide();
        }, 2000);
    })
    .catch(error => {
        console.error('Error sending checklist:', error);
        errorDiv.textContent = 'Error sending checklist. Please try again.';
        errorDiv.classList.remove('d-none');
    })
    .finally(() => {
        // Re-enable send button
        sendButton.disabled = false;
        sendButton.innerHTML = '<span class="material-icons me-1">send</span> Send Checklist';
    });
}
</script>

<style>
.checklist-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 1;
}

.checklist-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    z-index: 2;
}

/* Fix dropdown z-index issue */
.dropdown {
    position: relative;
}

.dropdown.show {
    z-index: 1050;
}

.dropdown-menu {
    z-index: 1051;
}

/* Ensure the card with open dropdown is above others */
.checklist-card:has(.dropdown.show) {
    z-index: 1050;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
}

.page-header h1 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    color: #333;
}

.modal-fullscreen .modal-body {
    padding: 0;
}

#checklistEditor {
    width: 100%;
    height: calc(100vh - 200px);
    border: none;
}

#editorLoading {
    background: #f8f9fa;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
    color: var(--kanardia-orange);
}

.spinner-border.text-primary {
    color: var(--kanardia-orange) !important;
}
</style>
{% endblock %}
