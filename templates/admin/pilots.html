{% extends "base.html" %}

{% block content %}
<!-- CSRF token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user-pilot"></i> Pilot Mappings</h2>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPilotModal">
                    <i class="fas fa-plus"></i> Create Mapping
                </button>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-pilot fa-2x me-3"></i>
                                <div>
                                    <h4 class="mb-0">{{ pilots.total }}</h4>
                                    <small>Total Mappings</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                                <div>
                                    <h4 class="mb-0">{{ unmapped_pilots|length }}</h4>
                                    <small>Unmapped Pilots</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle fa-2x me-3"></i>
                                <div>
                                    <h4 class="mb-0">{{ (pilots.total / (pilots.total + unmapped_pilots|length) * 100)|round(1) if (pilots.total + unmapped_pilots|length) > 0 else 0 }}%</h4>
                                    <small>Coverage</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unmapped Pilots Alert -->
            {% if unmapped_pilots %}
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <div>
                        <strong>Unmapped Pilots Found:</strong> {{ unmapped_pilots|join(', ') }}
                        <br><small>These pilot names appear in logbook entries but have no user mapping.</small>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Search and Filter -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search }}" placeholder="Pilot name, user email...">
                        </div>
                        <div class="col-md-4">
                            <label for="device_filter" class="form-label">Device</label>
                            <select class="form-select" id="device_filter" name="device_filter">
                                <option value="">All Devices</option>
                                {% for device in devices %}
                                <option value="{{ device.id }}" {% if device_filter == device.id|string %}selected{% endif %}>
                                    {{ device.name }} ({{ device.registration }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Search
                                </button>
                                <a href="{{ url_for('admin.pilots') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Pilot Mappings Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Pilot Mappings</h5>
                </div>
                <div class="card-body p-0">
                    {% if pilots.items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Pilot Name</th>
                                    <th>Mapped User</th>
                                    <th>Device</th>
                                    <th>Logbook Entries</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pilot in pilots.items %}
                                <tr>
                                    <td>
                                        <strong>{{ pilot.pilot_name }}</strong>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <strong>{{ pilot.user.nickname or pilot.user.email }}</strong><br>
                                                <small class="text-muted">{{ pilot.user.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ pilot.device.name }}</strong><br>
                                        <small class="text-muted">{{ pilot.device.registration }}</small>
                                    </td>
                                    <td>
                                        {% set entry_count = pilot.get_logbook_entry_count() %}
                                        {% if entry_count > 0 %}
                                            <span class="badge bg-success">{{ entry_count }} entries</span>
                                        {% else %}
                                            <span class="text-muted">No entries</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ pilot.created_at.strftime(current_user.date_format) if pilot.created_at else 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                onclick="confirmDelete({{ pilot.id }}, '{{ pilot.pilot_name }}', '{{ pilot.user.email }}', '{{ pilot.device.name }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if pilots.pages > 1 %}
                    <div class="card-footer">
                        <nav aria-label="Pilot mappings pagination">
                            <ul class="pagination justify-content-center mb-0">
                                {% if pilots.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.pilots', page=pilots.prev_num, search=search, device_filter=device_filter) }}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                                {% endif %}
                                
                                {% for page_num in pilots.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != pilots.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('admin.pilots', page=page_num, search=search, device_filter=device_filter) }}">{{ page_num }}</a>
                                        </li>
                                        {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                        {% endif %}
                                    {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if pilots.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.pilots', page=pilots.next_num, search=search, device_filter=device_filter) }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-user-pilot fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Pilot Mappings</h5>
                        <p class="text-muted">Create your first pilot mapping to link pilot names to users.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPilotModal">
                            <i class="fas fa-plus"></i> Create First Mapping
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Pilot Mapping Modal -->
<div class="modal fade" id="createPilotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create Pilot Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.create_pilot_mapping') }}">
                {{ form.hidden_tag() }}
                <div class="modal-body">
                    <div class="mb-3">
                        {{ form.pilot_name.label(class="form-label") }}
                        {{ form.pilot_name(class="form-control", placeholder="Enter pilot name as it appears in logbook", autocomplete="off") }}
                        <div class="form-text">This should match exactly how the pilot name appears in logbook entries.</div>
                        {% if form.pilot_name.errors %}
                            <div class="text-danger">
                                {% for error in form.pilot_name.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.user_id.label(class="form-label") }}
                        {{ form.user_id(class="form-select") }}
                        {% if form.user_id.errors %}
                            <div class="text-danger">
                                {% for error in form.user_id.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.device_id.label(class="form-label") }}
                        {{ form.device_id(class="form-select") }}
                        {% if form.device_id.errors %}
                            <div class="text-danger">
                                {% for error in form.device_id.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    {% if unmapped_pilots %}
                    <div class="alert alert-info">
                        <strong>Quick Select:</strong> Unmapped pilots found in logbook:
                        <div class="mt-2">
                            {% for pilot_name in unmapped_pilots %}
                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                    onclick="document.getElementById('pilot_name').value='{{ pilot_name }}'">
                                {{ pilot_name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="fas fa-trash"></i> Delete Pilot Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this pilot mapping?</p>
                <div class="alert alert-warning">
                    <strong>Pilot:</strong> <span id="deletePilotName"></span><br>
                    <strong>User:</strong> <span id="deleteUserEmail"></span><br>
                    <strong>Device:</strong> <span id="deleteDeviceName"></span>
                </div>
                <p class="text-muted">This action cannot be undone. Logbook entries will fall back to device owner assignment.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteForm" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">Delete Mapping</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete(pilotId, pilotName, userEmail, deviceName) {
    document.getElementById('deletePilotName').textContent = pilotName;
    document.getElementById('deleteUserEmail').textContent = userEmail;
    document.getElementById('deleteDeviceName').textContent = deviceName;
    document.getElementById('deleteForm').action = '/admin/pilots/' + pilotId + '/delete';
    
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

// Auto-complete for pilot names
document.getElementById('pilot_name').addEventListener('input', function(e) {
    const query = e.target.value;
    if (query.length < 2) return;
    
    fetch('/admin/api/pilots/suggestions?q=' + encodeURIComponent(query))
        .then(response => response.json())
        .then(suggestions => {
            // You could implement a dropdown here if needed
            console.log('Pilot suggestions:', suggestions);
        });
});
</script>

{% endblock %}
